<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StarStone Daily Deck - Rotating Gems</title>
  <style>
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#0b0f19;color:#e7ebff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'Hiragino Kaku Gothic ProN','Hiragino Sans','Noto Sans JP','Yu Gothic UI','Yu Gothic',Meiryo,sans-serif}
    main{max-width:960px;margin:0 auto;padding:24px}
    header{text-align:center;margin-bottom:12px}
    h1{margin:0 0 6px 0;font-size:28px;letter-spacing:0.02em}
    .badge{font-size:14px;padding:2px 8px;border:1px solid #2e3650;border-radius:999px;margin-left:6px;opacity:.7}
    .tagline{opacity:.75;margin:0 0 16px 0}
    #card-area{display:flex;flex-direction:column;align-items:center}
    .card-wrap{perspective:1200px}
    #card-canvas{box-shadow:0 8px 32px rgba(0,0,0,.6);background:#101728;max-width:100%;height:auto}
    #controls{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:16px 0 8px;align-items:center}
    button{border:1px solid #2e3650;background:#141a2b;color:#e7ebff;padding:10px 16px;border-radius:10px;cursor:pointer;font-size:15px}
    button:hover{background:#1a2338}
    button:disabled{opacity:.5;cursor:not-allowed}
    footer{opacity:.5;text-align:center;margin-top:24px}
  </style>
</head>
<body>
  <main>
    <header>
      <h1>StarStone Daily Deck <span class="badge">Rotating</span></h1>
      <p class="tagline">æ¯æœ1æšã€å®‡å®™ã®å°ã•ãªå„€å¼ã€‚â€” Gem & Moon Visuals</p>
    </header>

    <section id="card-area">
      <div class="card-wrap">
        <canvas id="card-canvas" width="800" height="1200"></canvas>
      </div>
    </section>

    <section id="controls">
      <button id="draw-btn">ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹ âœ¨</button>
      <button id="save-btn" disabled>ç”»åƒã‚’ä¿å­˜</button>
    </section>

    <footer>
      <small>Â© StarStone Deck â€” Make your morning a little cosmic.</small>
    </footer>
  </main>
  <script>
    // ===== DECK DATA with cuts assigned =====
    const DECK = [
      {"id":"z-aries","label":"ç‰¡ç¾Šåº§ Ã— ãƒ«ãƒ“ãƒ¼","category":"zodiac","symbol":"â™ˆ","stone":"ãƒ«ãƒ“ãƒ¼","action":"å°ã•ãå‹¢ã„ã‚’ã¤ã‘ã‚‹ã€‚30ç§’ã ã‘ã€ä»Šã™ãã§ãã‚‹ä¸€æ­©ã€ã‚’å®Ÿè¡Œã€‚","cut":"marquise"},
      {"id":"z-taurus","label":"ç‰¡ç‰›åº§ Ã— ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰","category":"zodiac","symbol":"â™‰","stone":"ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰","action":"äº”æ„Ÿã‚’æº€ãŸã™ã€‚æ¸©ã‹ã„é£²ã¿ç‰©ã‚’ã‚†ã£ãã‚Šå‘³ã‚ã†ã€‚","cut":"emerald"},
      {"id":"z-gemini","label":"åŒå­åº§ Ã— ã‚·ãƒˆãƒªãƒ³","category":"zodiac","symbol":"â™Š","stone":"ã‚·ãƒˆãƒªãƒ³","action":"é ­ã®æ›æ°—ã€‚çª“ã‚’é–‹ã‘ã€æ·±å‘¼å¸3å›ã—ã¦ã‹ã‚‰1è¡Œãƒ¡ãƒ¢ã€‚","cut":"oval"},
      {"id":"z-cancer","label":"èŸ¹åº§ Ã— ãƒ ãƒ¼ãƒ³ã‚¹ãƒˆãƒ¼ãƒ³","category":"zodiac","symbol":"â™‹","stone":"ãƒ ãƒ¼ãƒ³ã‚¹ãƒˆãƒ¼ãƒ³","action":"è‡ªåˆ†ã«å„ªã—ã„è¨€è‘‰ã‚’ä¸€ã¤ã€å£°ã«å‡ºã—ã¦ä¼ãˆã‚‹ã€‚","cut":"cabochon"},
      {"id":"z-leo","label":"ç…å­åº§ Ã— ã‚¿ã‚¤ã‚¬ãƒ¼ã‚¢ã‚¤","category":"zodiac","symbol":"â™Œ","stone":"ã‚¿ã‚¤ã‚¬ãƒ¼ã‚¢ã‚¤","action":"å§¿å‹¢ã‚’æ­£ã—ã¦1åˆ†ã€‚èƒ¸ã‚’é–‹ãã€ä»Šæ—¥ã¯ã“ã‚Œã‚’ã‚„ã‚‹ã¨å®£è¨€ã€‚","cut":"cabochon"},
      {"id":"z-virgo","label":"ä¹™å¥³åº§ Ã— ãƒšãƒªãƒ‰ãƒƒãƒˆ","category":"zodiac","symbol":"â™","stone":"ãƒšãƒªãƒ‰ãƒƒãƒˆ","action":"æœºä¸Šã‚’60ç§’ã ã‘æ•´ãˆã‚‹ã€‚ä¸è¦ãªã‚‚ã®ã‚’1ã¤ã ã‘é€€ã‘ã‚‹ã€‚","cut":"oval"},
      {"id":"z-libra","label":"å¤©ç§¤åº§ Ã— ãƒ©ãƒ”ã‚¹ãƒ©ã‚ºãƒª","category":"zodiac","symbol":"â™","stone":"ãƒ©ãƒ”ã‚¹ãƒ©ã‚ºãƒª","action":"èª°ã‹ä¸€äººã«çŸ­ã„æ„Ÿè¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã€‚","cut":"round"},
      {"id":"z-scorpio","label":"è åº§ Ã— ã‚ªãƒ–ã‚·ãƒ‡ã‚£ã‚¢ãƒ³","category":"zodiac","symbol":"â™","stone":"ã‚ªãƒ–ã‚·ãƒ‡ã‚£ã‚¢ãƒ³","action":"ä½™è¨ˆãªã‚¿ã‚¹ã‚¯ã‚’1ã¤ã ã‘åˆ‡ã‚Šæ¨ã¦ã‚‹ã€‚ã€ä»Šæ—¥ã¯ã‚„ã‚‰ãªã„ã€ã‚’é¸ã¶ã€‚","cut":"emerald"},
      {"id":"z-sagittarius","label":"å°„æ‰‹åº§ Ã— ã‚¿ãƒ¼ã‚³ã‚¤ã‚º","category":"zodiac","symbol":"â™","stone":"ã‚¿ãƒ¼ã‚³ã‚¤ã‚º","action":"å¤–ã‚’10æ­©ã ã‘æ­©ãã€‚ç©ºã‚’è¦‹ä¸Šã’ã¦æ·±å‘¼å¸ã€‚","cut":"cabochon"},
      {"id":"z-capricorn","label":"å±±ç¾Šåº§ Ã— ã‚¢ãƒ¡ã‚¸ã‚¹ãƒˆ","category":"zodiac","symbol":"â™‘","stone":"ã‚¢ãƒ¡ã‚¸ã‚¹ãƒˆ","action":"ä»Šæ—¥ã®æ„å›³ã‚’1è¡Œãƒãƒ¼ãƒˆã«è¨˜ã™ã€‚","cut":"round"},
      {"id":"z-aquarius","label":"æ°´ç“¶åº§ Ã— ãƒ©ãƒ–ãƒ©ãƒ‰ãƒ©ã‚¤ãƒˆ","category":"zodiac","symbol":"â™’","stone":"ãƒ©ãƒ–ãƒ©ãƒ‰ãƒ©ã‚¤ãƒˆ","action":"ã„ã¤ã‚‚ã¨é•ã†å ´æ‰€ã§1åˆ†ã ã‘åº§ã‚‹ã€‚è¦–ç‚¹ã‚’å¤‰ãˆã‚‹ã€‚","cut":"oval"},
      {"id":"z-pisces","label":"é­šåº§ Ã— ã‚¢ã‚¯ã‚¢ãƒãƒªãƒ³","category":"zodiac","symbol":"â™“","stone":"ã‚¢ã‚¯ã‚¢ãƒãƒªãƒ³","action":"æ°´ã‚’ä¸€æ¯ã‚†ã£ãã‚Šé£²ã¿ã€å¿ƒã‚’ã‚¯ãƒªã‚¢ã«ã€‚","cut":"oval"},
      {"id":"p-sun","label":"å¤ªé™½ Ã— ã‚¯ãƒªã‚¹ã‚¿ãƒ«","category":"planet","symbol":"â˜‰","stone":"ã‚¯ãƒªã‚¹ã‚¿ãƒ«","action":"å…‰ã‚’æµ´ã³ã¦1åˆ†ã€‚ã§ãã‚Œã°çª“éš›ã¸ã€‚èƒŒç­‹ã‚’ä¼¸ã°ã™ã€‚","cut":"brilliant"},
      {"id":"p-moon","label":"æœˆ Ã— ã‚»ãƒ¬ãƒŠã‚¤ãƒˆ","category":"planet","symbol":"â˜¾","stone":"ã‚»ãƒ¬ãƒŠã‚¤ãƒˆ","action":"é™ã‘ã•ã‚’æ€ã„å‡ºã™ã€‚ç›®ã‚’é–‰ã˜ã¦æ·±å‘¼å¸3å›ã€‚","cut":"cabochon"},
      {"id":"p-mercury","label":"æ°´æ˜Ÿ Ã— ãƒ•ãƒ­ãƒ¼ãƒ©ã‚¤ãƒˆ","category":"planet","symbol":"â˜¿","stone":"ãƒ•ãƒ­ãƒ¼ãƒ©ã‚¤ãƒˆ","action":"1åˆ†ãƒ–ãƒ¬ã‚¤ãƒ³ãƒ€ãƒ³ãƒ—ã€‚é ­ã®ä¸­ã®è¨€è‘‰ã‚’ç´™ã«åãå‡ºã™ã€‚","cut":"round"},
      {"id":"p-venus","label":"é‡‘æ˜Ÿ Ã— ãƒ­ãƒ¼ã‚ºã‚¯ã‚©ãƒ¼ãƒ„","category":"planet","symbol":"â™€","stone":"ãƒ­ãƒ¼ã‚ºã‚¯ã‚©ãƒ¼ãƒ„","action":"è‡ªåˆ†ã®å¥½ããªã‚‚ã®ã‚’1ã¤çœºã‚ã‚‹ or è§¦ã‚Œã‚‹ã€‚","cut":"heart"},
      {"id":"p-mars","label":"ç«æ˜Ÿ Ã— ã‚¬ãƒ¼ãƒãƒƒãƒˆ","category":"planet","symbol":"â™‚","stone":"ã‚¬ãƒ¼ãƒãƒƒãƒˆ","action":"ä½“ã‚’å‹•ã‹ã™ã€‚ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ10å› or è‚©å›ã—20å›ã€‚","cut":"marquise"},
      {"id":"p-jupiter","label":"æœ¨æ˜Ÿ Ã— ã‚¤ã‚¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚µã‚¤ãƒˆ","category":"planet","symbol":"â™ƒ","stone":"ã‚¤ã‚¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚µã‚¤ãƒˆ","action":"ä»Šæ—¥ã®ã€åºƒã’ãŸã„ã“ã¨ã€ã‚’1è¡Œæ›¸ãã€‚","cut":"round"},
      {"id":"p-saturn","label":"åœŸæ˜Ÿ Ã— ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼ã‚¯ã‚©ãƒ¼ãƒ„","category":"planet","symbol":"â™„","stone":"ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼ã‚¯ã‚©ãƒ¼ãƒ„","action":"ä»Šæ—¥ã‚„ã‚‰ãªã„ã“ã¨ã‚’1ã¤æ±ºã‚ã‚‹ã€‚å¢ƒç•Œç·šã‚’å¼•ãã€‚","cut":"emerald"},
      {"id":"p-uranus","label":"å¤©ç‹æ˜Ÿ Ã— ãƒ˜ãƒã‚¿ã‚¤ãƒˆ","category":"planet","symbol":"â™…","stone":"ãƒ˜ãƒã‚¿ã‚¤ãƒˆ","action":"ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’1ã¤ã ã‘å¤‰ãˆã‚‹ã€‚åˆ©ãæ‰‹ã¨é€†ã§æ­¯ç£¨ããªã©ã€‚","cut":"round"},
      {"id":"p-neptune","label":"æµ·ç‹æ˜Ÿ Ã— ãƒ©ãƒªãƒãƒ¼","category":"planet","symbol":"â™†","stone":"ãƒ©ãƒªãƒãƒ¼","action":"1åˆ†ã ã‘ç›®ã‚’é–‰ã˜ã¦ã€æµ®ã‹ã¶ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’çœºã‚ã‚‹ã€‚","cut":"oval"},
      {"id":"p-pluto","label":"å†¥ç‹æ˜Ÿ Ã— ãƒ–ãƒ©ãƒƒã‚¯ãƒˆãƒ«ãƒãƒªãƒ³","category":"planet","symbol":"â™‡","stone":"ãƒ–ãƒ©ãƒƒã‚¯ãƒˆãƒ«ãƒãƒªãƒ³","action":"å°ã•ãªã€æ‰‹æ”¾ã—ã€ã‚’1ã¤ã€‚é–‹ã„ã¦ã„ã‚‹ã‚¿ãƒ–ã‚’1ã¤é–‰ã˜ã‚‹ã€‚","cut":"emerald"},
      {"id":"e-fire","label":"ç« Ã— ã‚«ãƒ¼ãƒãƒªã‚¢ãƒ³","category":"element","symbol":"ğŸ”¥","stone":"ã‚«ãƒ¼ãƒãƒªã‚¢ãƒ³","action":"3åˆ†ã ã‘æƒ…ç†±ã‚¿ã‚¹ã‚¯ã€‚å‹¢ã„é‡è¦–ã§ç€æ‰‹ã€‚","cut":"marquise"},
      {"id":"e-earth","label":"åœ° Ã— ãƒãƒ©ã‚«ã‚¤ãƒˆ","category":"element","symbol":"â›°ï¸","stone":"ãƒãƒ©ã‚«ã‚¤ãƒˆ","action":"è¶³ã®è£ã‚’æ„Ÿã˜ã‚‹ã€‚ç«‹ã£ã¦30ç§’ã€ä½“é‡ã‚’æ„Ÿã˜ã‚‹ã€‚","cut":"cabochon"},
      {"id":"e-air","label":"é¢¨ Ã— ã‚¯ãƒªã‚½ãƒ—ãƒ¬ãƒ¼ã‚º","category":"element","symbol":"ğŸ’¨","stone":"ã‚¯ãƒªã‚½ãƒ—ãƒ¬ãƒ¼ã‚º","action":"éƒ¨å±‹ã®ç©ºæ°—ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã€‚çª“ã‚’å°‘ã—é–‹ã‘ã‚‹ã€‚","cut":"oval"},
      {"id":"e-water","label":"æ°´ Ã— ãƒ–ãƒ«ãƒ¼ãƒ¬ãƒ¼ã‚¹ã‚¢ã‚²ãƒ¼ãƒˆ","category":"element","symbol":"ğŸ’§","stone":"ãƒ–ãƒ«ãƒ¼ãƒ¬ãƒ¼ã‚¹ã‚¢ã‚²ãƒ¼ãƒˆ","action":"ã‚³ãƒƒãƒ—1æ¯ã®æ°´ã€‚é£²ã¿ãªãŒã‚‰3å‘¼å¸ã€‚","cut":"cabochon"},
      {"id":"w-meteor","label":"ãƒ¡ãƒ†ã‚ªãƒ©ã‚¤ãƒˆ Ã— éš•çŸ³","category":"wild","symbol":"â˜„ï¸","stone":"éš•çŸ³","action":"ã€æ€ã„ã¤ãã€ã‚’1ã¤ã‚„ã‚‹ã€‚çµæœã¯æ°—ã«ã—ãªã„ã€‚","cut":"round"},
      {"id":"w-aurora","label":"ã‚ªãƒ¼ãƒ­ãƒ© Ã— ã‚ªãƒ‘ãƒ©ã‚¤ãƒˆ","category":"wild","symbol":"ğŸŒˆ","stone":"ã‚ªãƒ‘ãƒ©ã‚¤ãƒˆ","action":"å¥½ããªéŸ³æ¥½ã‚’1æ›²ãƒ•ãƒ«å†ç”Ÿã€‚ä½“ã‚’å°‘ã—æºã‚‰ã™ã€‚","cut":"brilliant"},
      {"id":"w-comet","label":"å½—æ˜Ÿ Ã— ãƒ ãƒ¼ã‚«ã‚¤ãƒˆ","category":"wild","symbol":"ğŸª","stone":"ãƒ ãƒ¼ã‚«ã‚¤ãƒˆ","action":"æœªèª­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’1ã¤ã ã‘æ—¢èª­ã«ã—ã¦è¿”ä¿¡ã€‚","cut":"oval"},
      {"id":"w-void","label":"è™šç©º Ã— ãƒ–ãƒ©ãƒƒã‚¯ã‚ªãƒ‹ã‚­ã‚¹","category":"wild","symbol":"âš«","stone":"ãƒ–ãƒ©ãƒƒã‚¯ã‚ªãƒ‹ã‚­ã‚¹","action":"ã‚ãˆã¦ä½•ã‚‚ã—ãªã„1åˆ†ã€‚ç›®ã‚’é–‰ã˜ã€ç©ºç™½ã‚’å‘³ã‚ã†ã€‚","cut":"round"}
    ];

    // ===== Stone palettes =====
    const STONE = {
      "ã‚¢ã‚¯ã‚¢ãƒãƒªãƒ³":["#0c3850","#3aa9de","#c7ecff","#eaf7ff"],
      "ã‚¢ãƒ¡ã‚¸ã‚¹ãƒˆ":["#2c0a56","#7b4bd6","#d9c8ff","#ffffff"],
      "ãƒ­ãƒ¼ã‚ºã‚¯ã‚©ãƒ¼ãƒ„":["#5a274a","#d17aa8","#ffd6e9","#ffffff"],
      "ã‚¬ãƒ¼ãƒãƒƒãƒˆ":["#3b0013","#a11335","#ff5b76","#ffffff"],
      "ãƒ©ãƒ”ã‚¹ãƒ©ã‚ºãƒª":["#091b5a","#2960d1","#a9c4ff","#ffffff"],
      "ãƒ ãƒ¼ãƒ³ã‚¹ãƒˆãƒ¼ãƒ³":["#22304d","#7aa1ff","#eaf0ff","#ffffff"],
      "ãƒ«ãƒ“ãƒ¼":["#4a001e","#c41e4a","#ff6d9a","#ffffff"],
      "ã‚¿ã‚¤ã‚¬ãƒ¼ã‚¢ã‚¤":["#3e1c00","#c78117","#ffd27a","#fff3cc"],
      "ã‚»ãƒ¬ãƒŠã‚¤ãƒˆ":["#1d2130","#9ea9c9","#f2f6ff","#ffffff"],
      "ãƒ©ãƒ–ãƒ©ãƒ‰ãƒ©ã‚¤ãƒˆ":["#0b2b3f","#3aa0c9","#bff1ff","#ffffff"],
      "ãƒ˜ãƒã‚¿ã‚¤ãƒˆ":["#22262c","#7f8c99","#d6dde6","#ffffff"],
      "ã‚ªãƒ–ã‚·ãƒ‡ã‚£ã‚¢ãƒ³":["#0c0f14","#3b4958","#c6d3e1","#ffffff"],
      "ãƒ–ãƒ©ãƒƒã‚¯ãƒˆãƒ«ãƒãƒªãƒ³":["#0b0c10","#384353","#cad6e6","#ffffff"],
      "ã‚¯ãƒªã‚¹ã‚¿ãƒ«":["#1a2448","#9fb3ff","#eef4ff","#ffffff"],
      "ãƒ•ãƒ­ãƒ¼ãƒ©ã‚¤ãƒˆ":["#2a145a","#8e68e6","#decfff","#ffffff"],
      "ãƒšãƒªãƒ‰ãƒƒãƒˆ":["#1a3a0b","#63c214","#cfff83","#ffffff"],
      "ã‚·ãƒˆãƒªãƒ³":["#3a2500","#d89c18","#ffe089","#ffffff"],
      "éš•çŸ³":["#141a26","#718198","#d0d9e6","#ffffff"],
      "ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰":["#0a3b1e","#2d9c5a","#a8ffce","#ffffff"],
      "ã‚¿ãƒ¼ã‚³ã‚¤ã‚º":["#0f4550","#3eb5c9","#b8f3ff","#ffffff"],
      "ã‚¤ã‚¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚µã‚¤ãƒˆ":["#3b2f00","#d4a917","#ffe87a","#ffffff"],
      "ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼ã‚¯ã‚©ãƒ¼ãƒ„":["#2b2420","#7a6b5e","#d4cec6","#ffffff"],
      "ãƒ©ãƒªãƒãƒ¼":["#0e4a5f","#4db5d4","#c8f0ff","#ffffff"],
      "ã‚«ãƒ¼ãƒãƒªã‚¢ãƒ³":["#4a1500","#d15a1e","#ffb88a","#ffffff"],
      "ãƒãƒ©ã‚«ã‚¤ãƒˆ":["#0d3322","#2a8a5f","#a3ffd4","#ffffff"],
      "ã‚¯ãƒªã‚½ãƒ—ãƒ¬ãƒ¼ã‚º":["#1a3d28","#5cad7e","#c5ffe0","#ffffff"],
      "ãƒ–ãƒ«ãƒ¼ãƒ¬ãƒ¼ã‚¹ã‚¢ã‚²ãƒ¼ãƒˆ":["#1e3d52","#6b9fc4","#d0ebff","#ffffff"],
      "ã‚ªãƒ‘ãƒ©ã‚¤ãƒˆ":["#2d2044","#9b78d9","#ead8ff","#ffffff"],
      "ãƒ ãƒ¼ã‚«ã‚¤ãƒˆ":["#3d2018","#a86f48","#ffd4b0","#ffffff"],
      "ãƒ–ãƒ©ãƒƒã‚¯ã‚ªãƒ‹ã‚­ã‚¹":["#0a0a0c","#2b2d32","#b8bcc4","#ffffff"]
    };

    function seededRandom(seed){
      let s = 0; for (let i=0;i<seed.length;i++) s = (s*31 + seed.charCodeAt(i)) >>> 0;
      if (s <= 0) s = 1;
      return function(){ s = (s * 1664525 + 1013904223) >>> 0; return (s & 0xffffffff) / 0x100000000; };
    }

    function hexWithAlpha(hex, a){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      if (!m) return hex;
      const r = parseInt(m[1],16), g = parseInt(m[2],16), b = parseInt(m[3],16);
      return `rgba(${r},${g},${b},${a})`;
    }

    function drawFixedBG(ctx, w, h){
      const g = ctx.createLinearGradient(0,0,w,h);
      g.addColorStop(0, "#090c14"); g.addColorStop(1, "#111b2e");
      ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
      const rnd = seededRandom("starstone_bg_v1");
      for (let i=0;i<160;i++){
        const x = rnd()*w, y = rnd()*h, r = rnd()*1.7 + 0.2;
        if(r > 0) {
          ctx.fillStyle = `rgba(255,255,255,${0.25 + rnd()*0.7})`;
          ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
        }
      }
    }

    function glint(ctx, x, y, r){
      if(r <= 0) return;
      const g = ctx.createRadialGradient(x,y,0,x,y,r);
      g.addColorStop(0, "rgba(255,255,255,0.95)");
      g.addColorStop(1, "rgba(255,255,255,0.0)");
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    }

    // ===== GEM CUTS =====
    
    // Heart cut
    function heartPath(ctx, cx, cy, R){
      ctx.beginPath();
      ctx.moveTo(cx, cy + R*0.55);
      ctx.bezierCurveTo(cx - R, cy - R*0.2, cx - R*0.55, cy - R*0.95, cx, cy - R*0.55);
      ctx.bezierCurveTo(cx + R*0.55, cy - R*0.95, cx + R, cy - R*0.2, cx, cy + R*0.55);
      ctx.closePath();
    }

    function drawHeartFaceted(ctx, cx, cy, R, pal, seedKey){
      const g = ctx.createRadialGradient(cx, cy - R*0.2, R*0.2, cx, cy, R);
      g.addColorStop(0, pal[2]);
      g.addColorStop(0.55, pal[1]);
      g.addColorStop(1, pal[0]);
      ctx.save();
      heartPath(ctx, cx, cy, R);
      ctx.fillStyle = g;
      ctx.fill();
      ctx.clip();

      const rnd = seededRandom("heart_"+seedKey);
      for(let i=0;i<18;i++){
        const a = (i/18)*Math.PI*2 + rnd()*0.2;
        const x1 = cx + Math.cos(a)*R*0.1, y1 = cy + Math.sin(a)*R*0.1;
        const x2 = cx + Math.cos(a)*R*1.1, y2 = cy + Math.sin(a)*R*1.1;
        const lg = ctx.createLinearGradient(x1,y1,x2,y2);
        const shade = 0.10 + rnd()*0.22;
        lg.addColorStop(0, hexWithAlpha(pal[2], 0.10));
        lg.addColorStop(0.5, hexWithAlpha(pal[2], 0.18 + shade));
        lg.addColorStop(1, hexWithAlpha(pal[0], 0.08));
        ctx.fillStyle = lg;
        const w = 4 + rnd()*3;
        ctx.beginPath();
        ctx.moveTo(x1 - w, y1 - w);
        ctx.lineTo(x1 + w, y1 + w);
        ctx.lineTo(x2 + w, y2 + w);
        ctx.lineTo(x2 - w, y2 - w);
        ctx.closePath();
        ctx.fill();
      }
      ctx.restore();

      ctx.save();
      heartPath(ctx, cx, cy, R*1.02);
      ctx.strokeStyle = hexWithAlpha(pal[3], 0.75);
      ctx.lineWidth = 2.5;
      ctx.stroke();
      ctx.restore();

      glint(ctx, cx - R*0.25, cy - R*0.45, R*0.5);
      glint(ctx, cx + R*0.20, cy + R*0.05, R*0.28);
    }

    // Round cut
    function drawRoundFaceted(ctx, cx, cy, R, pal, seedKey){
      if(R <= 0) R = 100;
      const rnd = seededRandom("round_"+seedKey);
      const rg = ctx.createRadialGradient(cx,cy,R*0.18,cx,cy,R);
      rg.addColorStop(0, pal[1]);
      rg.addColorStop(0.65, pal[0]);
      rg.addColorStop(1, "#000");
      ctx.fillStyle=rg; 
      ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fill();

      ctx.save(); 
      ctx.beginPath(); 
      if(R > 0) ctx.arc(cx,cy,R,0,Math.PI*2); 
      ctx.clip();
      for(let i=0;i<28;i++){
        const a1=rnd()*Math.PI*2, a2=a1+(rnd()*0.5+0.15);
        const r1=R*(0.35+rnd()*0.55), r2=R*(0.35+rnd()*0.55);
        const p1=[cx+Math.cos(a1)*r1, cy+Math.sin(a1)*r1];
        const p2=[cx+Math.cos(a2)*r2, cy+Math.sin(a2)*r2];
        const p3=[cx+Math.cos((a1+a2)/2)*R*(0.15+rnd()*0.3),
                  cy+Math.sin((a1+a2)/2)*R*(0.15+rnd()*0.3)];
        const grad = ctx.createLinearGradient(p1[0],p1[1],p2[0],p2[1]);
        const shade = 0.25 + rnd()*0.5;
        grad.addColorStop(0, hexWithAlpha(pal[1],0.10));
        grad.addColorStop(0.5, hexWithAlpha(pal[2],0.18+shade*0.15));
        grad.addColorStop(1, hexWithAlpha(pal[0],0.10));
        ctx.fillStyle=grad;
        ctx.beginPath(); 
        ctx.moveTo(p1[0],p1[1]); 
        ctx.lineTo(p2[0],p2[1]); 
        ctx.lineTo(p3[0],p3[1]); 
        ctx.closePath(); 
        ctx.fill();
      }
      ctx.restore();

      const rim = ctx.createRadialGradient(cx,cy,R*0.9,cx,cy,R*1.05);
      rim.addColorStop(0,"transparent"); 
      rim.addColorStop(1, hexWithAlpha(pal[3],0.6));
      ctx.fillStyle=rim; 
      if(R > 0) {
        ctx.beginPath(); ctx.arc(cx,cy,R*1.05,0,Math.PI*2); ctx.fill();
      }
      glint(ctx, cx-R*0.35, cy-R*0.45, R*0.55);
      glint(ctx, cx+R*0.25, cy+R*0.10, R*0.35);
    }

    // Marquise cut
    function drawMarquiseFaceted(ctx, cx, cy, R, pal, seedKey){
      const L = R*1.7, W = R*0.85;
      const grad = ctx.createLinearGradient(cx-L/2, cy, cx+L/2, cy);
      grad.addColorStop(0, pal[0]); 
      grad.addColorStop(0.5, pal[1]); 
      grad.addColorStop(1, pal[0]);
      ctx.fillStyle=grad;
      ctx.beginPath();
      ctx.moveTo(cx-L/2, cy);
      ctx.quadraticCurveTo(cx-L/4, cy-W, cx, cy-W);
      ctx.quadraticCurveTo(cx+L/4, cy-W, cx+L/2, cy);
      ctx.quadraticCurveTo(cx+L/4, cy+W, cx, cy+W);
      ctx.quadraticCurveTo(cx-L/4, cy+W, cx-L/2, cy);
      ctx.closePath(); 
      ctx.fill();

      const rnd = seededRandom("marq_"+seedKey);
      ctx.save(); ctx.clip();
      for(let i=0;i<18;i++){
        const t = (i+1)/19;
        const x = cx-L/2 + L*t;
        const g = ctx.createLinearGradient(x, cy-W, x, cy+W);
        const shade = 0.12 + rnd()*0.35;
        g.addColorStop(0, hexWithAlpha(pal[2], 0.10));
        g.addColorStop(0.5, hexWithAlpha(pal[2], 0.18 + shade));
        g.addColorStop(1, hexWithAlpha(pal[0], 0.10));
        ctx.fillStyle = g;
        ctx.fillRect(x-2, cy-W, 4, W*2);
      }
      ctx.restore();

      ctx.strokeStyle = hexWithAlpha(pal[3], 0.8);
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      ctx.moveTo(cx-L/2, cy);
      ctx.quadraticCurveTo(cx-L/4, cy-W, cx, cy-W);
      ctx.quadraticCurveTo(cx+L/4, cy-W, cx+L/2, cy);
      ctx.quadraticCurveTo(cx+L/4, cy+W, cx, cy+W);
      ctx.quadraticCurveTo(cx-L/4, cy+W, cx-L/2, cy);
      ctx.closePath(); 
      ctx.stroke();

      glint(ctx, cx-L*0.15, cy-W*0.6, R*0.45);
      glint(ctx, cx+L*0.10, cy+W*0.25, R*0.32);
    }

    // Oval cut
    function drawOvalFaceted(ctx, cx, cy, R, pal, seedKey){
      ctx.save();
      ctx.translate(cx, cy);
      ctx.scale(1.2, 1.0);
      drawRoundFaceted(ctx, 0, 0, R, pal, seedKey);
      ctx.restore();
    }

    // Emerald cut
    function drawEmeraldFaceted(ctx, cx, cy, R, pal, seedKey){
      const s = R*0.9;
      const pts = [
        [cx-s*0.6, cy-s], [cx+s*0.6, cy-s],
        [cx+s, cy-s*0.6], [cx+s, cy+s*0.6],
        [cx+s*0.6, cy+s], [cx-s*0.6, cy+s],
        [cx-s, cy+s*0.6], [cx-s, cy-s*0.6]
      ];
      const g = ctx.createLinearGradient(cx-s, cy-s, cx+s, cy+s);
      g.addColorStop(0, pal[0]); 
      g.addColorStop(1, pal[1]);
      ctx.fillStyle=g; 
      ctx.beginPath();
      pts.forEach((p,i)=> i? ctx.lineTo(p[0],p[1]) : ctx.moveTo(p[0],p[1]));
      ctx.closePath(); 
      ctx.fill();

      const rnd = seededRandom("emer_"+seedKey);
      ctx.save(); ctx.clip();
      for(let i=0;i<16;i++){
        const t = 0.1 + 0.7*(i/16);
        ctx.strokeStyle = hexWithAlpha(pal[2], 0.12 + 0.12*(i/16));
        ctx.lineWidth = 1.2;
        ctx.beginPath();
        ctx.moveTo(cx - s*0.6*t, cy - s*t);
        ctx.lineTo(cx + s*0.6*t, cy - s*t);
        ctx.lineTo(cx + s*t, cy - s*0.6*t);
        ctx.lineTo(cx + s*t, cy + s*0.6*t);
        ctx.lineTo(cx + s*0.6*t, cy + s*t);
        ctx.lineTo(cx - s*0.6*t, cy + s*t);
        ctx.lineTo(cx - s*t, cy + s*0.6*t);
        ctx.lineTo(cx - s*t, cy - s*0.6*t);
        ctx.closePath(); 
        ctx.stroke();
      }
      ctx.restore();

      ctx.strokeStyle = hexWithAlpha(pal[3], 0.85);
      ctx.lineWidth = 2;
      ctx.beginPath();
      pts.forEach((p,i)=> i? ctx.lineTo(p[0],p[1]) : ctx.moveTo(p[0],p[1]));
      ctx.closePath(); 
      ctx.stroke();

      glint(ctx, cx - s*0.35, cy - s*0.35, R*0.45);
      glint(ctx, cx + s*0.15, cy + s*0.05, R*0.28);
    }

    // Cabochon (smooth dome)
    function drawCabochon(ctx, cx, cy, R, pal){
      if(R <= 0) R = 100;
      const rg = ctx.createRadialGradient(cx,cy,R*0.2,cx,cy,R);
      rg.addColorStop(0, pal[2]); 
      rg.addColorStop(0.65, pal[1]); 
      rg.addColorStop(1, pal[0]);
      ctx.fillStyle=rg; 
      ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fill();
      glint(ctx, cx-R*0.35, cy-R*0.45, R*0.55);
      glint(ctx, cx+R*0.25, cy+R*0.10, R*0.35);
      const rim = ctx.createRadialGradient(cx,cy,R*0.9,cx,cy,R*1.05);
      rim.addColorStop(0,"transparent"); 
      rim.addColorStop(1, hexWithAlpha(pal[3],0.55));
      ctx.fillStyle=rim; 
      if(R > 0) {
        ctx.beginPath(); ctx.arc(cx,cy,R*1.05,0,Math.PI*2); ctx.fill();
      }
    }

    // Brilliant cut (ğŸ’ diamond top view)
    function drawBrilliantFaceted(ctx, cx, cy, R, pal, seedKey){
      if(R <= 0) R = 100;
      const rnd = seededRandom("bril_"+seedKey);
      
      // Table (top flat)
      ctx.fillStyle = pal[2];
      ctx.beginPath();
      ctx.arc(cx, cy, R*0.3, 0, Math.PI*2);
      ctx.fill();

      // Crown facets (8 main kite shapes)
      for(let i=0;i<8;i++){
        const a1 = (i/8)*Math.PI*2;
        const a2 = ((i+1)/8)*Math.PI*2;
        const r1 = R*0.3, r2 = R*0.95;
        
        const grad = ctx.createLinearGradient(
          cx + Math.cos(a1)*r1, cy + Math.sin(a1)*r1,
          cx + Math.cos((a1+a2)/2)*r2, cy + Math.sin((a1+a2)/2)*r2
        );
        grad.addColorStop(0, pal[2]);
        grad.addColorStop(0.5, pal[1]);
        grad.addColorStop(1, pal[0]);
        
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(cx + Math.cos(a1)*r1, cy + Math.sin(a1)*r1);
        ctx.lineTo(cx + Math.cos((a1+a2)/2)*r2, cy + Math.sin((a1+a2)/2)*r2);
        ctx.lineTo(cx + Math.cos(a2)*r1, cy + Math.sin(a2)*r1);
        ctx.closePath();
        ctx.fill();
      }

      // Star facets (between main facets)
      for(let i=0;i<8;i++){
        const a1 = (i/8)*Math.PI*2 + Math.PI/16;
        const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, R);
        grad.addColorStop(0, hexWithAlpha(pal[2], 0.4));
        grad.addColorStop(1, hexWithAlpha(pal[0], 0.1));
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + Math.cos(a1)*R*0.3, cy + Math.sin(a1)*R*0.3);
        ctx.lineTo(cx + Math.cos(a1)*R*0.95, cy + Math.sin(a1)*R*0.95);
        ctx.closePath();
        ctx.fill();
      }

      // Rim highlight
      const rim = ctx.createRadialGradient(cx,cy,R*0.9,cx,cy,R*1.05);
      rim.addColorStop(0,"transparent");
      rim.addColorStop(1, hexWithAlpha(pal[3],0.75));
      ctx.fillStyle=rim;
      ctx.beginPath(); ctx.arc(cx,cy,R*1.05,0,Math.PI*2); ctx.fill();

      // Central sparkle
      glint(ctx, cx, cy, R*0.25);
      glint(ctx, cx - R*0.4, cy - R*0.3, R*0.4);
      glint(ctx, cx + R*0.35, cy + R*0.2, R*0.35);
    }

    // Dispatcher
    function drawGemFaceted(ctx, cut, cx, cy, R, pal, seedKey){
      switch(cut){
        case "heart": return drawHeartFaceted(ctx,cx,cy,R,pal,seedKey);
        case "marquise": return drawMarquiseFaceted(ctx,cx,cy,R,pal,seedKey);
        case "oval": return drawOvalFaceted(ctx,cx,cy,R,pal,seedKey);
        case "emerald": return drawEmeraldFaceted(ctx,cx,cy,R,pal,seedKey);
        case "cabochon": return drawCabochon(ctx,cx,cy,R,pal);
        case "brilliant": return drawBrilliantFaceted(ctx,cx,cy,R,pal,seedKey);
        case "round":
        default: return drawRoundFaceted(ctx,cx,cy,R,pal,seedKey);
      }
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = text.split('');
      let line = '';
      const lines = [];
      for(let i = 0; i < words.length; i++){
        const testLine = line + words[i];
        const metrics = ctx.measureText(testLine);
        if(metrics.width > maxWidth && i > 0){
          lines.push(line);
          line = words[i];
        } else {
          line = testLine;
        }
      }
      lines.push(line);
      for(let j = 0; j < lines.length; j++){
        ctx.fillText(lines[j], x, y + (j * lineHeight));
      }
    }

    // ===== Animation loop =====
    let animationId = null;
    let angle = 0;
    let currentCard = null;

    function drawCardFrame(ctx, W, H, card){
      drawFixedBG(ctx, W, H);
      
      // Border (sharp corners for gem card look)
      ctx.lineWidth = 3;
      ctx.strokeStyle = 'rgba(200,220,255,.45)';
      ctx.strokeRect(28,28,W-56,H-56);

      // Title
      ctx.fillStyle='#fff'; 
      ctx.textAlign='center';
      ctx.font='700 52px system-ui,-apple-system,Segoe UI,Roboto';
      ctx.fillText(card.symbol + ' ' + card.label, W/2, 520);

      // Divider
      ctx.strokeStyle='rgba(200,220,255,.25)';
      ctx.lineWidth=1; 
      ctx.beginPath(); 
      ctx.moveTo(120, 552); 
      ctx.lineTo(W-120, 552); 
      ctx.stroke();

      // Action
      ctx.font='26px system-ui,-apple-system,Segoe UI,Roboto';
      ctx.textAlign='left'; 
      ctx.fillStyle='#dbe2ff';
      wrapText(ctx, 'âœ¨ ' + card.action, 100, 600, W-200, 40);

      // Date
      const d=new Date();
      const ds=`${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
      ctx.textAlign='right'; 
      ctx.fillStyle='rgba(255,255,255,0.6)';
      ctx.font='20px system-ui,-apple-system,Segoe UI,Roboto';
      ctx.fillText(ds, W-50, H-50);
    }

    function runAnimation(card){
      const canvas = document.getElementById('card-canvas');
      const ctx = canvas.getContext('2d');
      const W = canvas.width, H = canvas.height;
      const pal = STONE[card.stone] || STONE["ã‚¯ãƒªã‚¹ã‚¿ãƒ«"];
      const cut = card.cut || "round";
      const cx = W/2, cy = 280, R = 150;

      if(animationId) cancelAnimationFrame(animationId);
      angle = 0;

      function tick(){
        ctx.clearRect(0,0,W,H);
        drawCardFrame(ctx, W, H, card);

        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle);
        ctx.translate(-cx, -cy);
        drawGemFaceted(ctx, cut, cx, cy, R, pal, card.stone);
        ctx.restore();

        angle += 0.005;
        animationId = requestAnimationFrame(tick);
      }
      tick();
    }

    // ===== Main =====
    const canvas = document.getElementById('card-canvas');
    const drawBtn = document.getElementById('draw-btn');
    const saveBtn = document.getElementById('save-btn');

    drawBtn.addEventListener('click', ()=>{
      const randomCard = DECK[Math.floor(Math.random() * DECK.length)];
      currentCard = randomCard;
      runAnimation(currentCard);
      saveBtn.disabled = false;
    });

    saveBtn.addEventListener('click', ()=>{
      if(!currentCard) return;
      if(animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      
      // Redraw one frame without rotation for save
      const ctx = canvas.getContext('2d');
      const W = canvas.width, H = canvas.height;
      const pal = STONE[currentCard.stone] || STONE["ã‚¯ãƒªã‚¹ã‚¿ãƒ«"];
      const cut = currentCard.cut || "round";
      const cx = W/2, cy = 280, R = 150;
      
      ctx.clearRect(0,0,W,H);
      drawCardFrame(ctx, W, H, currentCard);
      drawGemFaceted(ctx, cut, cx, cy, R, pal, currentCard.stone);
      
      const link = document.createElement('a');
      link.download = `StarStone-${currentCard.stone}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      // Resume animation
      runAnimation(currentCard);
    });
  </script>
</body>
</html>
